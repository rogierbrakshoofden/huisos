-- ============================================================================\n-- HuisOS v2 Schema Migration\n-- Run this in Supabase SQL Editor\n-- Date: 2025-12-29\n-- ============================================================================\n\n-- ============================================================================\n-- 1. CREATE NEW TASKS TABLE (replaces chores + tasks)\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS tasks (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  title TEXT NOT NULL,\n  description TEXT,\n  \n  -- Type & Recurrence\n  recurrence_type TEXT NOT NULL DEFAULT 'once' CHECK (recurrence_type IN ('once', 'repeating')),\n  frequency TEXT CHECK (frequency IN ('daily', 'every_two_days', 'weekly', 'monthly', 'yearly')),\n  recurrence_end_date DATE,\n  \n  -- Assignment (multiple people can be assigned)\n  assignee_ids UUID[] NOT NULL DEFAULT '{}',\n  \n  -- Rotation (only applies if recurrence_type = 'repeating')\n  rotation_enabled BOOLEAN DEFAULT false,\n  rotation_index INT DEFAULT 0,\n  rotation_exclude_ids UUID[] DEFAULT '{}',\n  \n  -- Grouping (for future feature: task bundles)\n  parent_task_id UUID REFERENCES tasks(id) ON DELETE SET NULL,\n  \n  -- State & Completion\n  completed BOOLEAN DEFAULT false,\n  completed_at TIMESTAMP,\n  completed_by UUID REFERENCES family_members(id) ON DELETE SET NULL,\n  completed_date DATE,\n  \n  -- Gamification\n  token_value INT DEFAULT 1 CHECK (token_value >= 0),\n  \n  -- Metadata\n  due_date DATE,\n  notes TEXT,\n  created_by UUID REFERENCES family_members(id) ON DELETE SET NULL,\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nCREATE INDEX IF NOT EXISTS idx_tasks_assignee_ids ON tasks USING gin(assignee_ids);\nCREATE INDEX IF NOT EXISTS idx_tasks_completed_date ON tasks(completed_date DESC);\nCREATE INDEX IF NOT EXISTS idx_tasks_created_at ON tasks(created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_tasks_recurrence_type ON tasks(recurrence_type);\n\n-- ============================================================================\n-- 2. CREATE SUBTASKS TABLE\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS subtasks (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  parent_task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,\n  title TEXT NOT NULL,\n  description TEXT,\n  \n  -- State\n  completed BOOLEAN DEFAULT false,\n  completed_at TIMESTAMP,\n  completed_by UUID REFERENCES family_members(id) ON DELETE SET NULL,\n  \n  -- Ordering\n  order_index INT DEFAULT 0,\n  \n  -- Metadata\n  created_at TIMESTAMP DEFAULT now(),\n  updated_at TIMESTAMP DEFAULT now()\n);\n\nCREATE INDEX IF NOT EXISTS idx_subtasks_parent_task ON subtasks(parent_task_id);\nCREATE INDEX IF NOT EXISTS idx_subtasks_completed ON subtasks(completed);\n\n-- ============================================================================\n-- 3. UPDATE EVENTS TABLE\n-- ============================================================================\n\nALTER TABLE events ADD COLUMN IF NOT EXISTS end_time TIME;\nALTER TABLE events ADD COLUMN IF NOT EXISTS recurring TEXT CHECK (recurring IN ('daily', 'weekly', 'monthly', 'yearly'));\nALTER TABLE events ADD COLUMN IF NOT EXISTS recurrence_end_date DATE;\n\nCREATE INDEX IF NOT EXISTS idx_events_recurring ON events(recurring);\nCREATE INDEX IF NOT EXISTS idx_events_datetime ON events(datetime DESC);\nCREATE INDEX IF NOT EXISTS idx_events_member_ids ON events USING gin(member_ids);\n\n-- ============================================================================\n-- 4. CREATE ACTIVITY LOG TABLE\n-- ============================================================================\n\nCREATE TABLE IF NOT EXISTS activity_log (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  actor_id UUID NOT NULL REFERENCES family_members(id) ON DELETE CASCADE,\n  action_type TEXT NOT NULL,\n  entity_type TEXT NOT NULL CHECK (entity_type IN ('task', 'subtask', 'event')),\n  entity_id UUID NOT NULL,\n  \n  -- Flexible metadata for action context\n  metadata JSONB DEFAULT '{}',\n  \n  created_at TIMESTAMP DEFAULT now(),\n  \n  -- Constraint: valid action types\n  CONSTRAINT valid_action_type CHECK (\n    action_type IN (\n      'task_created', 'task_completed', 'task_edited', 'task_deleted',\n      'subtask_created', 'subtask_completed', 'subtask_edited', 'subtask_deleted',\n      'event_created', 'event_edited', 'event_deleted',\n      'task_delegated', 'delegation_accepted', 'delegation_declined'\n    )\n  )\n);\n\nCREATE INDEX IF NOT EXISTS idx_activity_log_created_at ON activity_log(created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_activity_log_actor_id ON activity_log(actor_id);\nCREATE INDEX IF NOT EXISTS idx_activity_log_entity ON activity_log(entity_type, entity_id);\nCREATE INDEX IF NOT EXISTS idx_activity_log_action ON activity_log(action_type);\n\n-- ============================================================================\n-- 5. ENABLE REAL-TIME SUBSCRIPTIONS\n-- ============================================================================\n\n-- Uncomment in Supabase dashboard: Replication > tables > toggle ON\n-- ALTER PUBLICATION supabase_realtime ADD TABLE tasks;\n-- ALTER PUBLICATION supabase_realtime ADD TABLE subtasks;\n-- ALTER PUBLICATION supabase_realtime ADD TABLE events;\n-- ALTER PUBLICATION supabase_realtime ADD TABLE activity_log;\n\n-- ============================================================================\n-- MIGRATION COMPLETE\n-- ============================================================================\n\n-- Next steps:\n-- 1. Run the above SQL in Supabase SQL Editor\n-- 2. Enable realtime in Supabase dashboard > Replication > tables\n-- 3. Run data migration script: npm run migrate:chores\n\nCOMMIT;\n"